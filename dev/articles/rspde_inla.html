<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R-INLA implementation of the covariance-based rational approximation • rSPDE</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R-INLA implementation of the covariance-based rational approximation">
<meta property="og:description" content="rSPDE">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rSPDE</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.6.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rspde.html">An introduction to the `rSPDE` package</a>
    </li>
    <li>
      <a href="../articles/rspde_base.html">Using the rational approximation with the `rSPDE` package</a>
    </li>
    <li>
      <a href="../articles/rspde_cov.html">Using the covariance-based rational approximation with the `rSPDE` package</a>
    </li>
    <li>
      <a href="../articles/rspde_inla.html">R-INLA implementation of the covariance-based rational approximation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/davidbolin/rSPDE/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="rspde_inla_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R-INLA implementation of the covariance-based rational approximation</h1>
                        <h4 class="author">David Bolin, Alexandre B. Simas, Zhen Xiong</h4>
            
            <h4 class="date">10/29/2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/davidbolin/rSPDE/blob/master/vignettes/rspde_inla.Rmd"><code>vignettes/rspde_inla.Rmd</code></a></small>
      <div class="hidden name"><code>rspde_inla.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>In this vignette we will illustrate how to do statistical inference with the covariance-based rational SPDE approach. The covariance-based rational approximation is related to the <a href="https://www.tandfonline.com/doi/full/10.1080/10618600.2019.1665537">rational approximation by Bolin and Kirchner (2020)</a>.</p>
<p>We will consider a real world data set measuring one month precipitation from the Paraná region in Brazil. We will also provide a step-by-step illustration on how to use our implementation of the covariance-based rational approximation to the R-INLA package.</p>
<p>It is important to mention that one can improve the performance by using the PARDISO solver. Please, go to (<a href="https://www.pardiso-project.org/r-inla/#license" class="uri">https://www.pardiso-project.org/r-inla/#license</a>) to apply for a license. Also, use <code><a href="https://rdrr.io/pkg/INLA/man/pardiso.html">inla.pardiso()</a></code> for instructions on how to enable the PARDISO sparse library.</p>
</div>
<div id="covariance-based-rational-spde-approach" class="section level2">
<h2 class="hasAnchor">
<a href="#covariance-based-rational-spde-approach" class="anchor"></a>Covariance-based rational SPDE approach</h2>
<p>Let us first discuss the basic setup. We want to model the precipitation as a two-dimensional random field <span class="math inline">\(u\)</span> within a bounded domain, where each location on the domain associates with a random variable which describe the local precipitation.</p>
<p>In the SPDE approach, we model <span class="math inline">\(u\)</span> as the solution of the following SPDE: <span class="math display">\[L^{\alpha/2}(\tau u) = \mathcal{W},\]</span> where <span class="math inline">\(L = -\Delta +\kappa^2 I\)</span> and <span class="math inline">\(\mathcal{W}\)</span> is the standard Gaussian white noise. Here, <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\kappa\)</span> and <span class="math inline">\(\tau\)</span> are three parameters we want to estimate. In the standard SPDE approach, we write, for a general dimension <span class="math inline">\(d\)</span>, <span class="math inline">\(\alpha = \nu + d/2\)</span> and assume <span class="math inline">\(\nu\)</span> to be fixed. In the rational SPDE approach we are able to estimate a general smoothness <span class="math inline">\(\nu\)</span> from the data.</p>
<p>Now let us briefly describe how covariance based rational SPDE approach works in statistical inference.</p>
<p>First, we approximate the random field <span class="math inline">\(u\)</span>, which is the solution of the SPDE written above, by using the finite element method: <span class="math display">\[u_h(s_i)=\sum_{j=1}^{n_h} \hat{u}_j \varphi_j(s_i),\]</span> where <span class="math inline">\(\{\hat{u}_j\}_{j = 1}^{n_h}\)</span> are stochastic weights and <span class="math inline">\(\{\varphi_j(s_i)\}_{j = 1}^{n_h}\)</span> are fixed basis functions. The corresponding operator <span class="math inline">\(L\)</span> in terms of the finite element approximation is given by <span class="math inline">\(L_h\)</span>.</p>
<p>Now, by using the rational approximation, we can approximate covariance operator <span class="math inline">\(L_h^{\alpha}\)</span> as <span class="math display">\[L_{h,m}^{-\alpha} = L_h^{-m_\alpha} p(L_h^{-1})q(L_h^{-1})^{-1}.\]</span> Here <span class="math inline">\(m_{\alpha}\)</span> is set by user and it controls the regularity of <span class="math inline">\(u_h\)</span>, <span class="math inline">\(m\)</span> is the order of rational approximation, <span class="math inline">\(p(L_h^{-1}) = \sum_{i=0}^m a_i L_h^{m-i}\)</span> and <span class="math inline">\(q(L_h^{-1}) = \sum_{j=0}^m b_j L_h^{m-i}\)</span> where <span class="math inline">\(\{a_i\}_{i = 0}^m\)</span> and <span class="math inline">\(\{b_j\}_{j = 0}^m\)</span> are known coefficients obtained from the rational approximation.</p>
<p>The next step is to obtain the decomposition of <span class="math inline">\(p(L_h^{-1})q(L_h^{-1})^{-1}\)</span> into partial fractions to get the new representation: <span class="math display">\[L_{h,m}^{-\alpha} =L_h^{-m_\alpha} \left(\sum_{i=1}^{m}  r_i  (L_h-p_i I)^{-1} +k\right).\]</span> Based on the above operator equation, we can derive the covariance matrix of the stochastic weights <span class="math inline">\(\hat{\textbf{u}}\)</span>, where <span class="math inline">\(\hat{\textbf{u}}=[\hat{u}_1,...,\hat{u}_{n_h}]^\top\)</span>, as <span class="math display">\[\mathbf{\Sigma}_{\hat{\textbf{u}}} = (\textbf{L}^{-1}\textbf{C})^{m_{\alpha}} \sum_{i=1}^{m}r_i(\textbf{L}-p_i\textbf{C})^{-1}+\textbf{K}. \]</span> Here <span class="math inline">\(\textbf{C}\)</span> is mass matrix, <span class="math inline">\(\textbf{L} = \kappa^2\textbf{C}+\textbf{G}\)</span>, <span class="math inline">\(\textbf{G}\)</span> is stiffness matrix and <span class="math display">\[\textbf{K}=\left\{
    \begin{array}{lcl}
        k\textbf{C}      &amp;      &amp; {m_{\alpha}=0}\\
        k\textbf{L}^{-1}(\textbf{C}\textbf{L}^{-1})^{m_{\alpha}-1}    &amp;      &amp; {m_{\alpha}&gt;=1}\\
    \end{array} \right.\]</span></p>
<p>This actually indicates that we can express <span class="math inline">\(\hat{\textbf{u}}\)</span> as <span class="math display">\[\hat{\textbf{u}}=\sum_{i=1}^{m+1}\textbf{x}_i .\]</span></p>
<p>Here <span class="math display">\[\textbf{x}_i \sim N(\textbf{0},\textbf{Q}_i^{-1})\]</span> where <span class="math inline">\(\textbf{Q}_i\)</span> is the precision matrix of <span class="math inline">\(\textbf{x}_i\)</span> and <span class="math display">\[\textbf{Q}_i=\left \{
    \begin{array}{lcl}
        (\textbf{L}-p_i\textbf{C})(\textbf{C}^{-1}\textbf{L})^{m_{\alpha}}/r_i      &amp;      &amp; {i = 1,...,m}\\
         \textbf{K}^{-1}   &amp;      &amp; {i = m+1}\\
    \end{array} \right.\]</span></p>
<p>Now we can replace the Matérn latent field by the latent vector given above, which has precision matrix given by <span class="math display">\[\textbf{Q}=\begin{bmatrix}\textbf{Q}_1&amp; &amp;\\&amp;\ddots&amp;\\&amp; &amp;\textbf{Q}_{m+1}\end{bmatrix},\]</span> replace the standard <span class="math inline">\(A\)</span> matrix from the SPDE approach by the following <span class="math inline">\(A\)</span> matrix: <span class="math display">\[\overline{\textbf{A}}=\begin{bmatrix}\textbf{A}&amp;\cdots&amp;\textbf{A}\end{bmatrix}_{n\times n_h(m+1)},\]</span> where <span class="math display">\[\textbf{A}=\begin{bmatrix}\varphi_1(s_1)&amp;\cdots&amp;\varphi_{n_h}(s_1)\\\vdots&amp;\vdots&amp;\vdots\\\varphi_1(s_n)&amp;\cdots&amp;\varphi_{n_h}(s_n)\end{bmatrix}.\]</span></p>
<p>With these elements, we can use INLA to compute the posterior distribution of the three parameters we want to estimate.</p>
<p>The computational cost of a covariance-based rational approximation of order <span class="math inline">\(m\)</span> is approximately the same as the standard rational approximation of order <span class="math inline">\(m/2\)</span>. Therefore, we will use a convention to say that a covariance-based rational approximation is of order <span class="math inline">\(k\)</span>, to mean that we are choosing <span class="math inline">\(m=2k\)</span>. So, a covariance-based rational approximation of order <span class="math inline">\(2\)</span>, means that we are choosing <span class="math inline">\(m=4\)</span>, with the same computational cost as choosing <span class="math inline">\(m=2\)</span> in the standard rational approximation.</p>
</div>
<div id="example-with-real-data" class="section level2">
<h2 class="hasAnchor">
<a href="#example-with-real-data" class="anchor"></a>Example with real data</h2>
<p>To illustrate our implementation of rSPDE in INLA we will consider a dataset available in INLA. This data has also been used to illustrate the SPDE approach, see for instance the book <a href="https://www.routledge.com/Advanced-Spatial-Modeling-with-Stochastic-Partial-Differential-Equations/Krainski-Gomez-Rubio-Bakka-Lenzi-Castro-Camilo-Simpson-Lindgren-Rue/p/book/9780367570644">Advanced Spatial Modeling with Stochastic Partial Differential Equations Using R and INLA</a> and also the vignette <a href="https://sites.stat.washington.edu/peter/591/INLA.html">Spatial Statistics using R-INLA and Gaussian Markov random fields</a>.</p>
<p>The data consist of precipitation measurements from the Paraná region in Brazil and were provided by the Brazilian National Water Agency. The data were collected at 616 gauge stations in Paraná state, south of Brazil, for each day in 2011.</p>
</div>
<div id="a-rspde-model-for-precipitation" class="section level2">
<h2 class="hasAnchor">
<a href="#a-rspde-model-for-precipitation" class="anchor"></a>A rSPDE model for precipitation</h2>
<p>We will follow the vignette <a href="https://sites.stat.washington.edu/peter/591/INLA.html">Spatial Statistics using R-INLA and Gaussian Markov random fields</a>. As precipitation data are always positive, we will assume it is Gamma distributed. INLA uses the following parameterisation of the Gamma distribution, <span class="math display">\[\Gamma(\mu, c\phi): \pi (y) = \frac{1}{\Gamma(c\phi)} \left(\frac{c\phi}{\mu}\right)^{c\phi} y^{c\phi - 1} \exp\left(-\frac{c\phi y}{\mu}\right) .\]</span> In this parameterisation, the distribution has expected value <span class="math inline">\(E(x) = \mu\)</span> and variance <span class="math inline">\(V(x) = \mu^2/(c\phi)\)</span>, where <span class="math inline">\(c\)</span> is a fixed (known) scaling parameter and <span class="math inline">\(1/\phi\)</span> is a dispersion parameter.</p>
<p>In this example <span class="math inline">\(\mu\)</span> will be modelled using a stochastic model that includes both covariates and spatial structure, resulting in the latent Gaussian model for the precipitation measurements <span class="math display">\[\begin{align} y_i\mid \mu(s_i), \theta &amp;\sim \Gamma(\mu(s_i),c\phi)\\ \log (\mu(s)) &amp;= \eta(s) = \sum_k f_k(c_k(s))+x(s)\\ \theta &amp;\sim \pi(\theta) \end{align}.\]</span></p>
<p>where <span class="math inline">\(y_i\)</span> denotes the measurement taken at location <span class="math inline">\(s_i\)</span>, <span class="math inline">\(c_k(s)\)</span> are covariates, <span class="math inline">\(x(s)\)</span> is a mean-zero Gaussian Matérn field, and <span class="math inline">\(\theta\)</span> is a vector containing all parameters of the model, including smoothness of the field. That is, by using the rSPDE model, we will also be able to estimate the smoothness of the latent field.</p>
</div>
<div id="examining-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#examining-the-data" class="anchor"></a>Examining the data</h2>
<p>We will be using INLA. To install INLA go to <a href="https://www.r-inla.org/download-install">R-INLA Project</a>.</p>
<p>We begin by loading some libraries we need to get the data and build the plots.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://lattice.r-forge.r-project.org/">lattice</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.maths.lancs.ac.uk/~rowlings/Splancs/">splancs</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dnychka/fieldsRPackage">fields</a></span><span class="op">)</span></code></pre></div>
<p>Let us load the data and the border of the region</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">)</span></code></pre></div>
<p>The data frame contains daily measurements at 616 stations for the year 2011, as well as coordinates and altitude information for the measurement stations. We will not analyse the full spatio-temporal data set, but instead look at the total precipitation in January, which we calculate as</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span>, <span class="fl">3</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">31</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>In the next snippet of code, we extract the coordinates and altitudes and remove the locations with missing values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ind</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span>
<span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span><span class="va">ind</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">alt</span> <span class="op">&lt;-</span> <span class="va">PRprec</span><span class="op">$</span><span class="va">Altitude</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span></code></pre></div>
<p>Let us build a plot for the precipitations:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, colour <span class="op">=</span> <span class="va">Y</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, 
    alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fields/man/tim.colors.html">tim.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span>, 
    <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, 
    <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<p><img src="rspde_inla_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>The red line in the figure shows the coast line, and we expect the distance to the coast to be a good covariate for precipitation.</p>
<p>This covariate is not available, so let us calculate it for each observation location:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seaDist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spDistsN1.html">spDists</a></span><span class="op">(</span><span class="va">coords</span>, <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="op">]</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span>, 
    <span class="va">min</span><span class="op">)</span></code></pre></div>
<p>Now, let us plot the precipitation as a function of the possible covariates:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">seaDist</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Distance to sea"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">alt</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Altitude"</span><span class="op">)</span></code></pre></div>
<p><img src="rspde_inla_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="creating-the-rspde-model" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-the-rspde-model" class="anchor"></a>Creating the rSPDE model</h2>
<p>To use the INLA implementation of the rSPDE model we need to load the functions:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://davidbolin.github.io/rSPDE">rSPDE</a></span><span class="op">)</span></code></pre></div>
<div id="mesh" class="section level3">
<h3 class="hasAnchor">
<a href="#mesh" class="anchor"></a>Mesh</h3>
<p>We can use INLA for creating the mesh. Let us create a mesh which is based on a non-convex hull to avoid adding many small triangles outside the domain of interest (more triangles = larger computation times):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prdomain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.nonconvex.hull.html">inla.nonconvex.hull</a></span><span class="op">(</span><span class="va">coords</span>, <span class="op">-</span><span class="fl">0.03</span>, <span class="op">-</span><span class="fl">0.05</span>, resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>
<span class="va">prmesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html">inla.mesh.2d</a></span><span class="op">(</span>boundary <span class="op">=</span> <span class="va">prdomain</span>, max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">1</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prmesh</span>, asp <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">PRborder</span>, col <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<p><img src="rspde_inla_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
</div>
<div id="the-observation-matrix-a" class="section level3">
<h3 class="hasAnchor">
<a href="#the-observation-matrix-a" class="anchor"></a>The observation matrix (A)</h3>
<p>We now create the <span class="math inline">\(A\)</span> matrix, that connects the mesh to the observation locations and then create the rSPDE model.</p>
<p>For this task we need to use a rSPDE specific function, since the size of the <span class="math inline">\(A\)</span> matrix depends on the order of the rational approximation.</p>
<p>The default order is 2 for our covariance-based rational approximation. As mentioned in the description of the covariance-based rational approximation, what we call here order 2 is actually order 4, but has the same computational cost as a standard rational approximation of order 2.</p>
<p>There is an option to fix some smoothness, or the estimate smoothness. The default is to estimate smoothness.</p>
<p>In this first example we will assume we want a rational approximation of order 2, where we want to estimate the smoothness.</p>
<p>To this end we can use the <code>rspde_create_A</code> function. Since we will assume order 2 and that we want to estimate smoothness, the required parameters are simply the mesh and the locations:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Abar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.make.A.html">rspde.make.A</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, loc <span class="op">=</span> <span class="va">coords</span><span class="op">)</span></code></pre></div>
</div>
<div id="setting-up-the-rspde-model" class="section level3">
<h3 class="hasAnchor">
<a href="#setting-up-the-rspde-model" class="anchor"></a>Setting up the rSPDE model</h3>
<p>To set up a rSPDE model, all we need is the mesh and the dimension. By default it will assume that we want to estimate the smoothness parameter and that we will do a covariance-based rational approximation of order 2.</p>
<p>We will also see other options for setting up rSPDE models such as keeping the smoothness parameter fixed and/or increasing the order of the covariance-based rational approximation.</p>
<p>Therefore, to set up a model all we have to do is use the <code>rspde.matern</code> function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span><span class="op">)</span></code></pre></div>
</div>
<div id="the-inla-stack" class="section level3">
<h3 class="hasAnchor">
<a href="#the-inla-stack" class="anchor"></a>The inla.stack</h3>
<p>Since the covariates already are evaluated at the observation locations, we only want to apply the <span class="math inline">\(A\)</span> matrix to the spatial effect and not the fixed effects. We can use the <code>inla.stack</code> function.</p>
<p>The difference is that we need to use the function <code>rspde.make.index</code> to create the index:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mesh.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.make.index.html">rspde.make.index</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"field"</span>, mesh <span class="op">=</span> <span class="va">prmesh</span><span class="op">)</span></code></pre></div>
<p>We can then create the stack in a standard manner:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stk.dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span>, A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">Abar</span>, <span class="fl">1</span><span class="op">)</span>, tag <span class="op">=</span> <span class="st">"est"</span>, 
  effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mesh.index</span>, 
                   <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                 <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, 
                      lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
                      seaDist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">seaDist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Here the observation matrix <span class="math inline">\(A\)</span> is applied to the spatial effect and the intercept while an identity observation matrix, denoted by <span class="math inline">\(1\)</span>, is applied to the covariates. This means the covariates are unaffected by the observation matrix.</p>
<p>The observation matrices in <span class="math inline">\(A=list(Abar,1)\)</span> are used to link the corresponding elements in the effects-list to the observations. Thus in our model the latent spatial field <code>mesh.index</code> and the intercept are linked to the log-expectation of the observations, i.e. <span class="math inline">\(\eta(s)\)</span>, through the <span class="math inline">\(A\)</span>-matrix. The covariates, on the other hand, are linked directly to <span class="math inline">\(\eta(s)\)</span>. The <code>stk.dat</code> object defined above implies the following principal linkage between model components and observations <span class="math display">\[\eta(s) \sim A x(s) + A \text{ Intercept} + \text{long} + \text{lat}+ \text{seaDist}.\]</span> <span class="math inline">\(\eta(s)\)</span> will then be used in the observation-likelihood, <span class="math display">\[y_i\mid \eta(s_i),\theta \sim \Gamma(\exp(\eta (s_i)), c\phi).\]</span></p>
</div>
</div>
<div id="model-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#model-fitting" class="anchor"></a>Model fitting</h2>
<p>We will build a model using the distance to the sea <span class="math inline">\(x_i\)</span> as a covariate through an improper CAR(1) model with <span class="math inline">\(\beta_{ij}=1(i\sim j)\)</span>, which INLA calls a random walk of order 1.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f.s</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model</span><span class="op">)</span> </code></pre></div>
<p>Here <code>-1</code> is added to remove R’s implicit intercept, which is replaced by the explicit <code>+Intercept</code> from when we created the stack.</p>
<p>To fit the model we can use INLA:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat</span><span class="op">)</span>, 
            verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
            control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
            control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat</span><span class="op">)</span>, compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="inla-results" class="section level2">
<h2 class="hasAnchor">
<a href="#inla-results" class="anchor"></a>INLA results</h2>
<p>We can look at some summaries of the posterior distributions for the parameters, for example the fixed effects (i.e. the intercept) and the hyper-parameters (i.e. dispersion in the gamma likelihood, the precision of the RW1, and the parameters of the spatial field):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_fit</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat), ", " compute = TRUE), control.inla = 
##    list(int.strategy = \"eb\"))" ) 
## Time used:
##     Pre = 3.31, Running = 21.7, Post = 0.0808, Total = 25.1 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 0.648 0.019      0.611    0.648      0.685 0.648   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                     mean       sd 0.025quant
## Precision parameter for the Gamma observations    13.164    0.937     11.384
## Precision for seaDist                          10054.385 7606.794   2700.531
## Theta1 for field                                  -1.380    0.487     -2.413
## Theta2 for field                                   1.088    0.248      0.581
## Theta3 for field                                  -0.739    0.404     -1.459
##                                                0.5quant 0.975quant     mode
## Precision parameter for the Gamma observations   13.144     15.065   13.123
## Precision for seaDist                          7880.115  30161.515 5326.546
## Theta1 for field                                 -1.347     -0.510   -1.225
## Theta2 for field                                  1.096      1.555    1.125
## Theta3 for field                                 -0.767      0.119   -0.869
## 
## Marginal log-Likelihood:  -1262.56 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>Let <span class="math inline">\(\theta_1 = Theta1\)</span>, <span class="math inline">\(\theta_2=Theta2\)</span> and <span class="math inline">\(\theta_3=Theta3\)</span>, in terms of the SPDE <span class="math display">\[(\kappa^2 I - \Delta)^\beta(\tau u) = \mathcal{W},\]</span> where <span class="math inline">\(\beta = \nu/2 + d/4\)</span>, we have that <span class="math display">\[\kappa = \exp(\theta_1), \quad \nu = \exp(\theta_2) + d/4, \quad \tau = \exp(\theta_3).\]</span></p>
<p>We can obtain outputs with respect to parameters in the original scale by using the function <code><a href="../reference/rspde.result.html">rspde.result()</a></code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit</span>, <span class="st">"field"</span>, <span class="va">rspde_model</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">result_fit</span><span class="op">)</span></code></pre></div>
<pre><code>##           mean       sd 0.025quant 0.5quant 0.975quant     mode
## tau   0.280972 0.132264  0.0903789  0.26040   0.601678 0.210428
## kappa 3.056320 0.750653  1.7960400  2.99376   4.742820 2.861770
## nu    1.314310 0.350641  0.7569750  1.26890   2.120400 1.141940</code></pre>
<p>We can also plot the posterior densities:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">result_fit</span><span class="op">)</span></code></pre></div>
<p><img src="rspde_inla_files/figure-html/unnamed-chunk-18-1.png" width="700"><img src="rspde_inla_files/figure-html/unnamed-chunk-18-2.png" width="700"><img src="rspde_inla_files/figure-html/unnamed-chunk-18-3.png" width="700"></p>
</div>
<div id="changing-the-order-of-the-rational-approximation" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-the-order-of-the-rational-approximation" class="anchor"></a>Changing the order of the rational approximation</h2>
<p>To change the order of the rational approximation all we have to do is set the argument <code>rspde_order</code> to the desired value. The current available possibilities are <code>2,3</code> and <code>4</code> (corresponding to <code>4,6</code> and <code>8</code> to the standard rational approximation).</p>
<p>Let us fit the above model with the covariance-based rational approximation of order <code>3</code>:</p>
<ul>
<li>We build a new model:</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, rspde_order <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<ul>
<li>We create a new <span class="math inline">\(A\)</span> matrix:</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Abar_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.make.A.html">rspde.make.A</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, loc <span class="op">=</span> <span class="va">coords</span>, rspde_order <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<ul>
<li>We create a new index:</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mesh.index.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.make.index.html">rspde.make.index</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"field"</span>, mesh <span class="op">=</span> <span class="va">prmesh</span>, 
                                 rspde_order <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>Now the remaining is standard:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stk.dat.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span>, A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">Abar_3</span>, <span class="fl">1</span><span class="op">)</span>, tag <span class="op">=</span> <span class="st">"est"</span>, 
  effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mesh.index.3</span>, 
                   <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                 <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, 
                      lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
                      seaDist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">seaDist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">f.s.3</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model_3</span><span class="op">)</span>

<span class="va">rspde_fit_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s.3</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat.3</span><span class="op">)</span>, 
                    verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
            control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
            control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat.3</span><span class="op">)</span>, compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let us see the summary:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_fit_3</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s.3, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat.3), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat.3), ", " compute = TRUE), control.inla = 
##    list(int.strategy = \"eb\"))" ) 
## Time used:
##     Pre = 3.25, Running = 58.9, Post = 0.071, Total = 62.2 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 0.486 0.014      0.458    0.486      0.514 0.486   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                    mean       sd 0.025quant
## Precision parameter for the Gamma observations   13.167    0.902     11.484
## Precision for seaDist                          9403.601 6414.569   2567.554
## Theta1 for field                                 -1.405    0.470     -2.347
## Theta2 for field                                  1.153    0.228      0.709
## Theta3 for field                                 -0.736    0.285     -1.295
##                                                0.5quant 0.975quant     mode
## Precision parameter for the Gamma observations   13.136     15.031   13.075
## Precision for seaDist                          7695.765  26327.254 5388.908
## Theta1 for field                                 -1.400     -0.486   -1.383
## Theta2 for field                                  1.150      1.608    1.140
## Theta3 for field                                 -0.739     -0.165   -0.749
## 
## Marginal log-Likelihood:  -1262.65 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>Let us now see the summary in the original scale:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_fit_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit_3</span>, <span class="st">"field"</span>, <span class="va">rspde_model_3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">result_fit_3</span><span class="op">)</span></code></pre></div>
<pre><code>##           mean       sd 0.025quant 0.5quant 0.975quant     mode
## tau   0.273109 0.132350  0.0970666 0.246781   0.611111 0.198576
## kappa 3.245150 0.747771  2.0438700 3.158270   4.987560 2.980220
## nu    1.305910 0.246283  0.8658550 1.293130   1.832010 1.260860</code></pre>
</div>
<div id="estimating-models-with-fixed-smoothness" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-models-with-fixed-smoothness" class="anchor"></a>Estimating models with fixed smoothness</h2>
<p>We can fix the smoothness, say <span class="math inline">\(\nu\)</span>, of the model by providing the value of <span class="math inline">\(\nu\)</span>.</p>
<p>When the smoothness, <span class="math inline">\(\nu\)</span>, is fixed, we can have two possibilities:</p>
<ul>
<li><p><span class="math inline">\(\alpha = \nu + d/2\)</span> is integer;</p></li>
<li><p><span class="math inline">\(\alpha = \nu + d/2\)</span> is not integer.</p></li>
</ul>
<p>The first case, i.e., when <span class="math inline">\(\alpha\)</span> is integer, has much less computational cost. Furthermore, the <span class="math inline">\(A\)</span> matrix is different than the <span class="math inline">\(A\)</span> matrix for the non-integer <span class="math inline">\(\alpha\)</span>.</p>
<p>The <span class="math inline">\(A\)</span> matrix is the same for all values of <span class="math inline">\(\nu\)</span> such that <span class="math inline">\(\alpha\)</span> is integer. So, the <span class="math inline">\(A\)</span> matrix for these cases only need to be computed once. The same holds for the <code>index</code> obtained from the <code>rspde_make_index</code> function.</p>
<p>In the second case the <span class="math inline">\(A\)</span> matrix only depend on the order of the rational approximation and not on <span class="math inline">\(\nu\)</span>. Therefore, if the matrix <span class="math inline">\(A\)</span> has already been computed for some order, then the <span class="math inline">\(A\)</span> matrix will be same for all the values of <span class="math inline">\(\nu\)</span> such that <span class="math inline">\(\alpha\)</span> is non-integer. The same holds for the <code>index</code> obtained from the <code>rspde_make_index</code> function.</p>
<p>If <span class="math inline">\(\nu\)</span> is fixed, we have that the parameters returned by INLA are <span class="math display">\[\kappa = \exp(\theta_1)\quad\hbox{and}\quad\tau = \exp(\theta_2).\]</span></p>
<div id="estimating-models-with-fixed-smoothness-and-non-integer-alpha" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-models-with-fixed-smoothness-and-non-integer-alpha" class="anchor"></a>Estimating models with fixed smoothness and non-integer <span class="math inline">\(\alpha\)</span>
</h3>
<p>Recall that <span class="math display">\[\nu = \exp(\theta_2)+d/4.\]</span></p>
<p>Thus, let us consider a fixed <span class="math inline">\(\nu\)</span> given by the mean of <span class="math inline">\(\nu\)</span> obtained from the third-order model, namely, the fit given by <code>rspde_fit_3</code>, which is approximately <span class="math inline">\(\nu = 0.78\)</span>.</p>
<p>Let us also consider initially a model of order 2.</p>
<p>Notice that for this <span class="math inline">\(\nu\)</span>, the value of <span class="math inline">\(\alpha\)</span> is non-integer, so we can use the <span class="math inline">\(A\)</span> matrix and the index of the first fitted model, which is also of order 2.</p>
<p>Therefore, all we have to do is build a new model in which we set <code>nu</code> to <code>0.78</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, rspde_order <span class="op">=</span> <span class="fl">2</span>,
                                       nu <span class="op">=</span> <span class="fl">0.78</span><span class="op">)</span></code></pre></div>
<p>Let us now fit the model:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f.s.fix</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model_fix</span><span class="op">)</span>

<span class="va">rspde_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s.fix</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat</span><span class="op">)</span>, 
                verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
              control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
              control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat</span><span class="op">)</span>, compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Here we have the summary:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_fix</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s.fix, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat), ", " compute = TRUE), control.inla = 
##    list(int.strategy = \"eb\"))" ) 
## Time used:
##     Pre = 3.15, Running = 11.5, Post = 0.0606, Total = 14.7 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 0.648 0.019       0.61    0.648      0.686 0.648   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                     mean       sd 0.025quant
## Precision parameter for the Gamma observations    13.306 9.02e-01     11.608
## Precision for seaDist                          16477.600 2.17e+04   2896.973
## Theta1 for field                                  -0.396 2.59e-01     -0.871
## Theta2 for field                                   0.793 4.12e-01     -0.079
##                                                0.5quant 0.975quant     mode
## Precision parameter for the Gamma observations    13.28   1.52e+01   13.237
## Precision for seaDist                          10031.08   6.93e+04 5322.665
## Theta1 for field                                  -0.41   1.44e-01   -0.458
## Theta2 for field                                   0.82   1.53e+00    0.919
## 
## Marginal log-Likelihood:  -1262.23 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>Now, the summary in the original scale:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fix</span>, <span class="st">"field"</span>, <span class="va">rspde_model_fix</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">result_fix</span><span class="op">)</span></code></pre></div>
<pre><code>##           mean       sd 0.025quant 0.5quant 0.975quant     mode
## tau   0.695364 0.187790   0.419548 0.664019    1.15636 0.601704
## kappa 2.391870 0.953406   0.930994 2.271780    4.63247 1.980040</code></pre>
<div id="increasing-the-order" class="section level4">
<h4 class="hasAnchor">
<a href="#increasing-the-order" class="anchor"></a>Increasing the order</h4>
<p>Let us fit the same model as above, but with order 3 from the covariance-based rational approximation.</p>
<p>Notice that we already computed the <span class="math inline">\(A\)</span> matrix and the <code>index</code> for the third order model. Thus, all we have to do is build a new model and fit:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model_fix_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, rspde_order <span class="op">=</span> <span class="fl">3</span>,
                                       nu <span class="op">=</span> <span class="fl">0.78</span><span class="op">)</span>

<span class="va">f.s.fix.3</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model_fix_3</span><span class="op">)</span>

<span class="va">rspde_fix_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s.fix.3</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat.3</span><span class="op">)</span>, 
                  verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
                control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
                control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat.3</span><span class="op">)</span>, compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Here we have the summary:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_fix_3</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s.fix.3, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat.3), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat.3), ", " compute = TRUE), control.inla = 
##    list(int.strategy = \"eb\"))" ) 
## Time used:
##     Pre = 3.15, Running = 13.3, Post = 0.0644, Total = 16.5 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 0.486 0.014      0.458    0.486      0.514 0.486   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                    mean       sd 0.025quant
## Precision parameter for the Gamma observations   13.289    0.908     11.543
## Precision for seaDist                          9600.914 6297.730   3269.712
## Theta1 for field                                 -0.361    0.296     -0.879
## Theta2 for field                                  0.766    0.422     -0.151
##                                                0.5quant 0.975quant     mode
## Precision parameter for the Gamma observations   13.279   1.51e+01   13.285
## Precision for seaDist                          7816.989   2.63e+04 5593.610
## Theta1 for field                                 -0.386   2.74e-01   -0.474
## Theta2 for field                                  0.804   1.50e+00    0.945
## 
## Marginal log-Likelihood:  -1262.44 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>Now, the summary in the original scale:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_fix_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fix_3</span>, <span class="st">"field"</span>, <span class="va">rspde_model_fix_3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">result_fix_3</span><span class="op">)</span></code></pre></div>
<pre><code>##          mean       sd 0.025quant 0.5quant 0.975quant     mode
## tau   0.72789 0.230999   0.416560 0.680183    1.31706 0.590312
## kappa 2.33597 0.930904   0.867378 2.237120    4.45744 1.954880</code></pre>
</div>
</div>
<div id="estimating-models-with-fixed-smoothness-and-integer-alpha" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-models-with-fixed-smoothness-and-integer-alpha" class="anchor"></a>Estimating models with fixed smoothness and integer <span class="math inline">\(\alpha\)</span>
</h3>
<p>We will illustrate this case to describe a two-stages strategy to reduce computational cost.</p>
<p>To such an end we will dedicate an entire section to the strategy.</p>
</div>
</div>
<div id="two-stages-estimation-strategy" class="section level2">
<h2 class="hasAnchor">
<a href="#two-stages-estimation-strategy" class="anchor"></a>Two-stages estimation strategy</h2>
<p>To be able to use R-INLA to fit a rSPDE model, we need to restrict the interval of estimation of the smoothness parameter to a bounded interval. Furthermore, the optimization will be carried out based on the sparsity of the precision matrix on the value of <span class="math inline">\(\nu\)</span> on the supremum of this interval. The reason is that the precision matrix gets denser as <span class="math inline">\(\nu\)</span> increases. Therefore, the smaller we can define the maximum value of <span class="math inline">\(\nu\)</span>, the faster the optimization will be.</p>
<p>The default maximum value of <span class="math inline">\(\nu\)</span> is <code>7</code> and can be changed by setting the argument <code>nu_upper_bound</code> to the desired value inside the <code>create_rspde_model</code> function.</p>
<p>Notice, however, that since we do not know the true value of <span class="math inline">\(\nu\)</span> we need an strategy to be able to reduce the computational cost and still obtain a reasonable estimate of <span class="math inline">\(\nu\)</span>.</p>
<div id="the-strategy" class="section level3">
<h3 class="hasAnchor">
<a href="#the-strategy" class="anchor"></a>The strategy</h3>
<p>The core of the strategy comes from the fact that the sparsity of the precision matrix increases with <span class="math inline">\(\nu\)</span> as long as <span class="math inline">\(\alpha=\nu+d/2\)</span> is non-integer. If <span class="math inline">\(\alpha\)</span> is integer, then the sparsity is the same, regardless of <span class="math inline">\(\nu\)</span>. Furthermore, the size of the precision matrix for the case in which <span class="math inline">\(\alpha\)</span> is integer is also much smaller than in the non-integer case. More precisely, if we consider a precision matrix from the covariance-based rational approximation of order <span class="math inline">\(m\)</span>, then the precision matrix has size <span class="math inline">\((2m+1)N\times (2m+1)N\)</span>, where <span class="math inline">\(N\)</span> is the number of rows of the precision matrix for the integer case.</p>
<p>The idea is then to do sequential estimates of the parameters with <span class="math inline">\(\nu\)</span> fixed and being chosen across the integers until the marginal likelihood, evaluated at the fitted parameters for that fixed <span class="math inline">\(\nu\)</span>, starts to decrease. We then choose such a <span class="math inline">\(\nu\)</span> as the upper bound.</p>
<p>Let us now illustrate the idea explicitly.</p>
<p>Since we are in dimension <span class="math inline">\(d=2\)</span>, and <span class="math inline">\(\nu&gt;0\)</span>, the smallest value of <span class="math inline">\(\nu\)</span> that makes <span class="math inline">\(\alpha = \nu + 1\)</span> an integer is <span class="math inline">\(\nu=1\)</span>. Let us fit such a model.</p>
<p>To this end we need to compute a new <span class="math inline">\(A\)</span> matrix:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Abar.int</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.make.A.html">rspde.make.A</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, loc <span class="op">=</span> <span class="va">coords</span>,
                       nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>a new index:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mesh.index.int</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.make.index.html">rspde.make.index</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"field"</span>, mesh <span class="op">=</span> <span class="va">prmesh</span>,
                                  nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>create a new model (remember to set <code>nu=1</code>):</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model_fix_int1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>,
                                     nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>The remaining is standard:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stk.dat.int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span>, A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">Abar.int</span>, <span class="fl">1</span><span class="op">)</span>, tag <span class="op">=</span> <span class="st">"est"</span>, 
  effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mesh.index.int</span>, 
                   <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                 <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, 
                      lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
                      seaDist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html">inla.group</a></span><span class="op">(</span><span class="va">seaDist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">f.s.fix.int.1</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model_fix_int1</span><span class="op">)</span>

<span class="va">rspde_fix_int_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s.fix.int.1</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, 
                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat.int</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
                  control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
                  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat.int</span><span class="op">)</span>, 
                                           compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let us check the summary:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_fix_int_1</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s.fix.int.1, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat.int), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat.int), ", " compute = TRUE), control.inla 
##    = list(int.strategy = \"eb\"))" ) 
## Time used:
##     Pre = 3.14, Running = 5.58, Post = 0.0438, Total = 8.76 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 1.945 0.055      1.837    1.945      2.052 1.945   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                     mean       sd 0.025quant
## Precision parameter for the Gamma observations    13.278 8.99e-01     11.577
## Precision for seaDist                          11522.989 1.14e+04   2526.894
## Theta1 for field                                  -0.886 2.76e-01     -1.417
## Theta2 for field                                   1.048 3.19e-01      0.403
##                                                0.5quant 0.975quant     mode
## Precision parameter for the Gamma observations    13.26     15.114   13.223
## Precision for seaDist                           8065.29  41283.494 4836.507
## Theta1 for field                                  -0.89     -0.333   -0.907
## Theta2 for field                                   1.06      1.659    1.083
## 
## Marginal log-Likelihood:  -1260.79 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>The value of the marginal likelihood for this model was <code>-1259.47</code>.</p>
<p>Let us now estimate the model for the next value of <span class="math inline">\(\nu\)</span> such that <span class="math inline">\(\alpha\)</span> is an integer. Such value is <span class="math inline">\(\nu = 2\)</span>. Let us fit such a model.</p>
<p>Notice that we do not need to compute the <span class="math inline">\(A\)</span> matrix nor the index since we already computed them.</p>
<p>Thus,</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model_fix_int2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>,
                                            nu <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">f.s.fix.int.2</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model_fix_int2</span><span class="op">)</span>

<span class="va">rspde_fix_int_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s.fix.int.2</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, 
                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat.int</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
                      control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
                      control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat.int</span><span class="op">)</span>, 
                                               compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let us now check the summary:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_fix_int_2</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s.fix.int.2, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat.int), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat.int), ", " compute = TRUE), control.inla 
##    = list(int.strategy = \"eb\"))" ) 
## Time used:
##     Pre = 3.38, Running = 5.35, Post = 0.0404, Total = 8.77 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 1.944 0.055      1.836    1.944      2.051 1.944   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                   mean       sd 0.025quant
## Precision parameter for the Gamma observations   13.00    0.820      11.46
## Precision for seaDist                          7579.44 3841.414    2699.80
## Theta1 for field                                 -2.90    0.326      -3.56
## Theta2 for field                                  1.39    0.178       1.05
##                                                0.5quant 0.975quant    mode
## Precision parameter for the Gamma observations    12.98      14.69   12.92
## Precision for seaDist                           6726.62   17557.22 5366.21
## Theta1 for field                                  -2.90      -2.27   -2.88
## Theta2 for field                                   1.39       1.75    1.39
## 
## Marginal log-Likelihood:  -1259.70 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>Now, observe that the marginal likelihood for <span class="math inline">\(\nu=2\)</span> was <code>-1262.25</code> which is smaller than <code>-1259.47</code>. Thus, we expect the true <span class="math inline">\(\nu\)</span> to be less than <code>2</code>. Hence, we will set <code>2</code> as our upper bound for <span class="math inline">\(\nu\)</span> by setting <code>nu_upper_bound = 2</code> inside the <code>create_rspde_model</code> function:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_model_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, 
                                      nu_upper_bound <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">f.s.gen</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">seaDist</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">field</span>, model <span class="op">=</span> <span class="va">rspde_model_gen</span><span class="op">)</span>

<span class="va">rspde_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">f.s.gen</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>, 
                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.data</a></span><span class="op">(</span><span class="va">stk.dat</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
                      control.inla<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int.strategy<span class="op">=</span><span class="st">'eb'</span><span class="op">)</span>,
                      control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html">inla.stack.A</a></span><span class="op">(</span><span class="va">stk.dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let us see the summary:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rspde_gen</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
##    c("inla(formula = f.s.gen, family = \"Gamma\", data = 
##    inla.stack.data(stk.dat), ", " verbose = FALSE, control.predictor = 
##    list(A = inla.stack.A(stk.dat)), ", " control.inla = list(int.strategy 
##    = \"eb\"))") 
## Time used:
##     Pre = 3.5, Running = 21.8, Post = 0.0564, Total = 25.4 
## Fixed effects:
##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld
## Intercept 0.647 0.019      0.609    0.647      0.685 0.647   0
## 
## Random effects:
##   Name     Model
##     seaDist RW1 model
##    field RGeneric2
## 
## Model hyperparameters:
##                                                    mean       sd 0.025quant
## Precision parameter for the Gamma observations   13.057    0.909     11.422
## Precision for seaDist                          9716.408 6605.836   2510.744
## Theta1 for field                                 -1.607    0.608     -2.868
## Theta2 for field                                  1.197    0.263      0.697
## Theta3 for field                                  0.793    0.610     -0.352
##                                                0.5quant 0.975quant    mode
## Precision parameter for the Gamma observations    13.00     14.990   12.85
## Precision for seaDist                           7997.41  26984.538 5552.02
## Theta1 for field                                  -1.58     -0.452   -1.50
## Theta2 for field                                   1.19      1.737    1.16
## Theta3 for field                                   0.77      2.047    0.69
## 
## Marginal log-Likelihood:  -1260.75 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
<p>Let us compare the computational times for the first model, with the default value of <code>nu_upper_bound</code>, with the one obtained from the two-stages strategy:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_fit</span><span class="op">$</span><span class="va">cpu.used</span></code></pre></div>
<pre><code>##         Pre     Running        Post       Total 
##  3.30642486 21.72764802  0.08076215 25.11483502</code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_fix_int_1</span><span class="op">$</span><span class="va">cpu.used</span></code></pre></div>
<pre><code>##        Pre    Running       Post      Total 
## 3.13655710 5.57668591 0.04378104 8.75702405</code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_fix_int_2</span><span class="op">$</span><span class="va">cpu.used</span></code></pre></div>
<pre><code>##        Pre    Running       Post      Total 
## 3.37838101 5.35242891 0.04039907 8.77120900</code></pre>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rspde_gen</span><span class="op">$</span><span class="va">cpu.used</span></code></pre></div>
<pre><code>##         Pre     Running        Post       Total 
##  3.49910903 21.80706000  0.05638504 25.36255407</code></pre>
<p>Observe that time computational time of the model <code>rspde_fit</code> was bigger than the sum of the computational times of <code>rspde_fix_int_1</code>, <code>rspde_fix_int_2</code> and <code>rspde_gen</code>.</p>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by David Bolin, Alexandre Simas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
