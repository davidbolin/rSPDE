<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rSPDE">
<title>inlabru implementation of the rational SPDE approach • rSPDE</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Roboto_Slab-0.4.7/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="inlabru implementation of the rational SPDE approach">
<meta property="og:description" content="rSPDE">
<meta property="og:image" content="https://davidbolin.github.io/rSPDE/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rSPDE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rSPDE.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/rspde_inla.html">R-INLA implementation of the rational SPDE approach</a>
    <a class="dropdown-item" href="../articles/rspde_inlabru.html">inlabru implementation of the rational SPDE approach</a>
    <a class="dropdown-item" href="../articles/rspde_cov.html">Rational approximation with the rSPDE package</a>
    <a class="dropdown-item" href="../articles/rspde_base.html">Operator-based rational approximation</a>
    <a class="dropdown-item" href="../articles/build_source.html">Building the rSPDE package from source on Mac and Linux</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/davidbolin/rSPDE/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://twitter.com/jdavidbolin" aria-label="Twitter">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>inlabru implementation of the rational SPDE approach</h1>
                        <h4 data-toc-skip class="author">David Bolin and
Alexandre B. Simas</h4>
            
            <h4 data-toc-skip class="date">Created: 2022-09-13. Last
modified: 2023-10-26.</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/davidbolin/rSPDE/blob/HEAD/vignettes/rspde_inlabru.Rmd" class="external-link"><code>vignettes/rspde_inlabru.Rmd</code></a></small>
      <div class="d-none name"><code>rspde_inlabru.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we will present the <a href="http://inlabru.org/" class="external-link"><code>inlabru</code></a> implementation of
the covariance-based rational SPDE approach. For further technical
details on the covariance-based approach, see the <a href="rspde_cov.html">Rational approximation with the <code>rSPDE</code>
package</a> vignette and <a href="https://doi.org/10.1080/10618600.2023.2231051" class="external-link"><span class="citation">Bolin, Simas, and Xiong (2023)</span></a>.</p>
<p>We begin by providing a step-by-step illustration on how to use our
implementation. To this end we will consider a real world data set that
consists of precipitation measurements from the Paraná region in
Brazil.</p>
<p>After the initial model fitting, we will show how to change some
parameters of the model. In the end, we will also provide an example in
which we have replicates.</p>
<p>The examples in this vignette are the same as those in the <a href="rspde_inla.html">R-INLA implementation of the rational SPDE
approach</a> vignette. As in that case, it is important to mention that
one can improve the performance by using the PARDISO solver. Please, go
to <a href="https://www.pardiso-project.org/r-inla/#license" class="external-link uri">https://www.pardiso-project.org/r-inla/#license</a> to apply
for a license. Also, use <code><a href="https://rdrr.io/pkg/INLA/man/pardiso.html" class="external-link">inla.pardiso()</a></code> for instructions on
how to enable the PARDISO sparse library.</p>
</div>
<div class="section level2">
<h2 id="an-example-with-real-data">An example with real data<a class="anchor" aria-label="anchor" href="#an-example-with-real-data"></a>
</h2>
<p>To illustrate our implementation of <code>rSPDE</code> in <a href="http://inlabru.org/" class="external-link"><code>inlabru</code></a> we will consider a
dataset available in <a href="https://www.r-inla.org" class="external-link"><code>R-INLA</code></a>. This data has
also been used to illustrate the SPDE approach, see for instance the
book <a href="https://www.routledge.com/Advanced-Spatial-Modeling-with-Stochastic-Partial-Differential-Equations/Krainski-Gomez-Rubio-Bakka-Lenzi-Castro-Camilo-Simpson-Lindgren-Rue/p/book/9780367570644" class="external-link">Advanced
Spatial Modeling with Stochastic Partial Differential Equations Using R
and INLA</a> and also the vignette <a href="https://sites.stat.washington.edu/peter/591/INLA.html" class="external-link">Spatial
Statistics using R-INLA and Gaussian Markov random fields</a>. See also
<a href="https://rss.onlinelibrary.wiley.com/doi/full/10.1111/j.1467-9868.2011.00777.x" class="external-link"><span class="citation">Lindgren, Rue, and Lindström (2011)</span></a> for
theoretical details on the standard SPDE approach.</p>
<p>The data consist of precipitation measurements from the Paraná region
in Brazil and were provided by the Brazilian National Water Agency. The
data were collected at 616 gauge stations in Paraná state, south of
Brazil, for each day in 2011.</p>
<div class="section level3">
<h3 id="an-rspde-model-for-precipitation">An rSPDE model for precipitation<a class="anchor" aria-label="anchor" href="#an-rspde-model-for-precipitation"></a>
</h3>
<p>We will follow the vignette <a href="https://sites.stat.washington.edu/peter/591/INLA.html" class="external-link">Spatial
Statistics using R-INLA and Gaussian Markov random fields</a>. As
precipitation data are always positive, we will assume it is Gamma
distributed. <a href="https://www.r-inla.org" class="external-link"><code>R-INLA</code></a>
uses the following parameterization of the Gamma distribution, <span class="math display">\[\Gamma(\mu, \phi): \pi (y) =
\frac{1}{\Gamma(\phi)} \left(\frac{\phi}{\mu}\right)^{\phi} y^{\phi - 1}
\exp\left(-\frac{\phi y}{\mu}\right) .\]</span> In this
parameterization, the distribution has expected value <span class="math inline">\(E(x) = \mu\)</span> and variance <span class="math inline">\(V(x) = \mu^2/\phi\)</span>, where <span class="math inline">\(1/\phi\)</span> is a dispersion parameter.</p>
<p>In this example <span class="math inline">\(\mu\)</span> will be
modelled using a stochastic model that includes both covariates and
spatial structure, resulting in the latent Gaussian model for the
precipitation measurements <span class="math display">\[\begin{align}
y_i\mid \mu(s_i), \theta &amp;\sim \Gamma(\mu(s_i),c\phi)\\ \log
(\mu(s)) &amp;= \eta(s) = \sum_k f_k(c_k(s))+u(s)\\ \theta &amp;\sim
\pi(\theta) \end{align},\]</span></p>
<p>where <span class="math inline">\(y_i\)</span> denotes the
measurement taken at location <span class="math inline">\(s_i\)</span>,
<span class="math inline">\(c_k(s)\)</span> are covariates, <span class="math inline">\(u(s)\)</span> is a mean-zero Gaussian Matérn
field, and <span class="math inline">\(\theta\)</span> is a vector
containing all parameters of the model, including smoothness of the
field. That is, by using the <code>rSPDE</code> model we will also be
able to estimate the smoothness of the latent field.</p>
</div>
<div class="section level3">
<h3 id="examining-the-data">Examining the data<a class="anchor" aria-label="anchor" href="#examining-the-data"></a>
</h3>
<p>We will be using <a href="http://inlabru.org/" class="external-link"><code>inlabru</code></a>. The
<code>inlabru</code> package is available on CRAN and also on <a href="https://github.com/inlabru-org/inlabru" class="external-link">GitHub</a>.</p>
<p>We begin by loading some libraries we need to get the data and build
the plots.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.inlabru.org" class="external-link">inlabru</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.maths.lancs.ac.uk/~rowlings/Splancs/" class="external-link">splancs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span></code></pre></div>
<p>Let us load the data and the border of the region</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">)</span></span></code></pre></div>
<p>The data frame contains daily measurements at 616 stations for the
year 2011, as well as coordinates and altitude information for the
measurement stations. We will not analyze the full spatio-temporal data
set, but instead look at the total precipitation in January, which we
calculate as</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span>, <span class="fl">3</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">31</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>In the next snippet of code, we extract the coordinates and altitudes
and remove the locations with missing values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span><span class="va">ind</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">alt</span> <span class="op">&lt;-</span> <span class="va">PRprec</span><span class="op">$</span><span class="va">Altitude</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span></span></code></pre></div>
<p>Let us build a plot for the precipitations:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    colour <span class="op">=</span> <span class="va">Y</span></span>
<span>  <span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span></span>
<span>    <span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>,</span>
<span>    <span class="fl">2</span></span>
<span>  <span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_precipitations-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The red line in the figure shows the coast line, and we expect the
distance to the coast to be a good covariate for precipitation.</p>
<p>This covariate is not available, so let us calculate it for each
observation location:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seaDist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spDistsN1.html" class="external-link">spDists</a></span><span class="op">(</span><span class="va">coords</span>, <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="op">]</span>,</span>
<span>  longlat <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">min</span><span class="op">)</span></span></code></pre></div>
<p>Now, let us plot the precipitation as a function of the possible
covariates:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Longitude"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">seaDist</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Distance to sea"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">alt</span>, <span class="va">Y</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, xlab <span class="op">=</span> <span class="st">"Altitude"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_prec_as_func-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-the-rspde-model">Creating the rSPDE model<a class="anchor" aria-label="anchor" href="#creating-the-rspde-model"></a>
</h3>
<p>To use the <a href="http://inlabru.org/" class="external-link"><code>inlabru</code></a>
implementation of the <code>rSPDE</code> model we need to load the
functions:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidbolin.github.io/rSPDE/">rSPDE</a></span><span class="op">)</span></span></code></pre></div>
<p>To create a <code>rSPDE</code> model, one would the
<code><a href="../reference/rspde.matern.html">rspde.matern()</a></code> function in a similar fashion as one would
use the <code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.matern.html" class="external-link">inla.spde2.matern()</a></code> function.</p>
<div class="section level4">
<h4 id="mesh">Mesh<a class="anchor" aria-label="anchor" href="#mesh"></a>
</h4>
<p>We can use <code><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d()</a></code> function from the
<code>fmesher</code> package for creating the mesh. Let us create a mesh
which is based on a non-convex hull to avoid adding many small triangles
outside the domain of interest:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inlabru-org.github.io/fmesher/" class="external-link">fmesher</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">prdomain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_nonconvex_hull.html" class="external-link">fm_nonconvex_hull</a></span><span class="op">(</span><span class="va">coords</span>, <span class="op">-</span><span class="fl">0.03</span>, <span class="op">-</span><span class="fl">0.05</span>, resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prmesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d</a></span><span class="op">(</span>boundary <span class="op">=</span> <span class="va">prdomain</span>, max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">1</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">prmesh</span>, asp <span class="op">=</span> <span class="fl">1</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">PRborder</span>, col <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/mesh_creation-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="setting-up-the-data-frame">Setting up the data frame<a class="anchor" aria-label="anchor" href="#setting-up-the-data-frame"></a>
</h4>
<p>In place of a <code>inla.stack</code>, we can set up a
<code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> to use <a href="http://inlabru.org/" class="external-link"><code>inlabru</code></a>. We refer the reader
to vignettes in <a href="https://inlabru-org.github.io/inlabru/index.html" class="external-link uri">https://inlabru-org.github.io/inlabru/index.html</a> for
further details.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>long <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, lat <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, </span>
<span>                        seaDist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/group.html" class="external-link">inla.group</a></span><span class="op">(</span><span class="va">seaDist</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="va">prdata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"long"</span>,<span class="st">"lat"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="setting-up-the-rspde-model">Setting up the rSPDE model<a class="anchor" aria-label="anchor" href="#setting-up-the-rspde-model"></a>
</h4>
<p>To set up an <code>rSPDE</code>model, all we need is the mesh. By
default it will assume that we want to estimate the smoothness parameter
<span class="math inline">\(\nu\)</span> and to do a covariance-based
rational approximation of order 2.</p>
<p>Later in this vignette we will also see other options for setting up
<code>rSPDE</code> models such as keeping the smoothness parameter fixed
and/or increasing the order of the covariance-based rational
approximation.</p>
<p>Therefore, to set up a model all we have to do is use the
<code><a href="../reference/rspde.matern.html">rspde.matern()</a></code> function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rspde_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span><span class="op">)</span></span></code></pre></div>
<p>Notice that this function is very reminiscent of <a href="https://www.r-inla.org" class="external-link"><code>R-INLA</code></a>’s
<code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.matern.html" class="external-link">inla.spde2.matern()</a></code> function.</p>
<p>We will assume the following linkage between model components and
observations <span class="math display">\[\eta(s) \sim A x(s) + A \text{
Intercept} + \text{seaDist}.\]</span> <span class="math inline">\(\eta(s)\)</span> will then be used in the
observation-likelihood, <span class="math display">\[y_i\mid
\eta(s_i),\theta \sim \Gamma(\exp(\eta (s_i)), c\phi).\]</span></p>
</div>
</div>
<div class="section level3">
<h3 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h3>
<p>We will build a model using the distance to the sea <span class="math inline">\(x_i\)</span> as a covariate through an improper
CAR(1) model with <span class="math inline">\(\beta_{ij}=1(i\sim
j)\)</span>, which <a href="https://www.r-inla.org" class="external-link"><code>R-INLA</code></a> calls a random
walk of order 1. We will fit it in <code>inlabru</code>’s style:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="fu">Intercept</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">distSea</span><span class="op">(</span><span class="va">seaDist</span>, model<span class="op">=</span><span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">field</span><span class="op">(</span><span class="va">coordinates</span>, model <span class="op">=</span> <span class="va">rspde_model</span><span class="op">)</span></span></code></pre></div>
<p>To fit the model we simply use the <code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru()</a></code> function:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rspde_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span><span class="va">cmp</span>, data <span class="op">=</span> <span class="va">prdata</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"Gamma"</span>,</span>
<span>  options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    control.inla <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int.strategy <span class="op">=</span> <span class="st">"eb"</span><span class="op">)</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inlabru-results">inlabru results<a class="anchor" aria-label="anchor" href="#inlabru-results"></a>
</h3>
<p>We can look at some summaries of the posterior distributions for the
parameters, for example the fixed effects (i.e. the intercept) and the
hyper-parameters (i.e. dispersion in the gamma likelihood, the precision
of the RW1, and the parameters of the spatial field):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rspde_fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## inlabru version: 2.9.0</span></span>
<span><span class="co">## INLA version: 23.10.25</span></span>
<span><span class="co">## Components:</span></span>
<span><span class="co">## Intercept: main = linear(1), group = exchangeable(1L), replicate = iid(1L)</span></span>
<span><span class="co">## distSea: main = rw1(seaDist), group = exchangeable(1L), replicate = iid(1L)</span></span>
<span><span class="co">## field: main = cgeneric(coordinates), group = exchangeable(1L), replicate = iid(1L)</span></span>
<span><span class="co">## Likelihoods:</span></span>
<span><span class="co">##   Family: 'Gamma'</span></span>
<span><span class="co">##     Data class: 'SpatialPointsDataFrame'</span></span>
<span><span class="co">##     Predictor: y ~ .</span></span>
<span><span class="co">## Time used:</span></span>
<span><span class="co">##     Pre = 0.914, Running = 197, Post = 0.634, Total = 199 </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##            mean    sd 0.025quant 0.5quant 0.975quant  mode kld</span></span>
<span><span class="co">## Intercept 1.944 0.052      1.841    1.944      2.046 1.944   0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##   Name     Model</span></span>
<span><span class="co">##     distSea RW1 model</span></span>
<span><span class="co">##    field CGeneric</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model hyperparameters:</span></span>
<span><span class="co">##                                                     mean       sd 0.025quant</span></span>
<span><span class="co">## Precision parameter for the Gamma observations    13.973    0.997      12.08</span></span>
<span><span class="co">## Precision for distSea                          10127.629 7624.454    2523.95</span></span>
<span><span class="co">## Theta1 for field                                   0.796    1.151      -1.13</span></span>
<span><span class="co">## Theta2 for field                                   0.358    0.963      -1.74</span></span>
<span><span class="co">## Theta3 for field                                  -3.056    1.533      -6.42</span></span>
<span><span class="co">##                                                0.5quant 0.975quant     mode</span></span>
<span><span class="co">## Precision parameter for the Gamma observations   13.949     16.003   13.925</span></span>
<span><span class="co">## Precision for distSea                          8045.646  30440.969 5337.568</span></span>
<span><span class="co">## Theta1 for field                                  0.703      3.331    0.239</span></span>
<span><span class="co">## Theta2 for field                                  0.428      2.005    0.774</span></span>
<span><span class="co">## Theta3 for field                                 -2.936     -0.468   -2.338</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Deviance Information Criterion (DIC) ...............: 2485.82</span></span>
<span><span class="co">## Deviance Information Criterion (DIC, saturated) ....: 715.57</span></span>
<span><span class="co">## Effective number of parameters .....................: 101.31</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Watanabe-Akaike information criterion (WAIC) ...: 2491.10</span></span>
<span><span class="co">## Effective number of parameters .................: 92.33</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Marginal log-Likelihood:  -1258.37 </span></span>
<span><span class="co">##  is computed </span></span>
<span><span class="co">## Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre>
<p>Let <span class="math inline">\(\theta_1 = \textrm{Theta1}\)</span>,
<span class="math inline">\(\theta_2=\textrm{Theta2}\)</span> and <span class="math inline">\(\theta_3=\textrm{Theta3}\)</span>. In terms of the
SPDE <span class="math display">\[(\kappa^2 I - \Delta)^{\alpha/2}(\tau
u) = \mathcal{W},\]</span> where <span class="math inline">\(\alpha =
\nu + d/2\)</span>, we have that <span class="math display">\[\tau =
\exp(\theta_1),\quad \kappa = \exp(\theta_2), \]</span> and by default
<span class="math display">\[\nu =
4\Big(\frac{\exp(\theta_3)}{1+\exp(\theta_3)}\Big).\]</span> The number
4 comes from the upper bound for <span class="math inline">\(\nu\)</span>, which is discussed in <a href="rspde_inla.html">R-INLA implementation of the rational SPDE
approach</a> vignette.</p>
<p>In general, we have <span class="math display">\[\nu =
\nu_{UB}\Big(\frac{\exp(\theta_3)}{1+\exp(\theta_3)}\Big),\]</span>
where <span class="math inline">\(\nu_{UB}\)</span> is the value of the
upper bound for the smoothness parameter <span class="math inline">\(\nu\)</span>.</p>
<p>Another choice for prior for <span class="math inline">\(\nu\)</span>
is a truncated lognormal distribution and is also discussed in <a href="rspde_inla.html">R-INLA implementation of the rational SPDE
approach</a> vignette.</p>
</div>
<div class="section level3">
<h3 id="inlabru-results-in-the-original-scale">inlabru results in the original scale<a class="anchor" aria-label="anchor" href="#inlabru-results-in-the-original-scale"></a>
</h3>
<p>We can obtain outputs with respect to parameters in the original
scale by using the function <code><a href="../reference/rspde.result.html">rspde.result()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit</span>, <span class="st">"field"</span>, </span>
<span>                <span class="va">rspde_model</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           mean       sd 0.025quant 0.5quant 0.975quant       mode</span></span>
<span><span class="co">## tau   4.755110 9.633940 0.32412200 1.959470   27.21550 0.69074900</span></span>
<span><span class="co">## kappa 2.137190 1.960350 0.17939400 1.572050    7.37406 0.49435500</span></span>
<span><span class="co">## nu    0.360209 0.412448 0.00673735 0.209595    1.53050 0.00815949</span></span></code></pre>
<p>We can also plot the posterior densities. To this end we will use the
<code><a href="../reference/gg_df.html">gg_df()</a></code> function, which creates <code>ggplot2</code>
user-friendly data frames:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior_df_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gg_df.html">gg_df</a></span><span class="op">(</span><span class="va">result_fit</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">posterior_df_fit</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_post-1.png" width="700" style="display: block; margin: auto;"></p>
<p>We can also obtain the summary on a different parameterization by
setting the <code>parameterization</code> argument on the
<code><a href="../reference/rspde.result.html">rspde.result()</a></code> function:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_fit_matern</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit</span>, <span class="st">"field"</span>, </span>
<span>                <span class="va">rspde_model</span>, parameterization <span class="op">=</span> <span class="st">"matern"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_fit_matern</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             mean        sd 0.025quant 0.5quant 0.975quant       mode</span></span>
<span><span class="co">## std.dev 0.155530 0.0897725 0.00808953 0.157077   0.314419 0.22934500</span></span>
<span><span class="co">## range   1.021420 0.5711000 0.31468600 0.891706   2.428960 0.67115800</span></span>
<span><span class="co">## nu      0.360209 0.4124480 0.00673735 0.209595   1.530500 0.00815949</span></span></code></pre>
<p>In a similar manner, we can obtain posterior plots on the
<code>matern</code> parameterization:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior_df_fit_matern</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gg_df.html">gg_df</a></span><span class="op">(</span><span class="va">result_fit_matern</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">posterior_df_fit_matern</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_post_matern-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="predictions">Predictions<a class="anchor" aria-label="anchor" href="#predictions"></a>
</h3>
<p>Let us now obtain predictions (i.e. do kriging) of the expected
precipitation on a dense grid in the region.</p>
<p>We begin by creating the grid in which we want to do the predictions.
To this end, we can use the <code><a href="https://inlabru-org.github.io/fmesher/reference/fm_evaluate.html" class="external-link">fm_evaluator()</a></code> function:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nxy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">projgrid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_evaluate.html" class="external-link">fm_evaluator</a></span><span class="op">(</span><span class="va">prmesh</span>,</span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, dims <span class="op">=</span> <span class="va">nxy</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This lattice contains 150 × 100 locations. One can easily change the
resolution of the kriging prediction by changing <code>nxy</code>. Let
us find the cells that are outside the region of interest so that we do
not plot the estimates there.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xy.in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsbivand.github.io/splancs/reference/inout.html" class="external-link">inout</a></span><span class="op">(</span><span class="va">projgrid</span><span class="op">$</span><span class="va">lattice</span><span class="op">$</span><span class="va">loc</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">PRborder</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let us plot the locations that we will do prediction:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coord.prd</span> <span class="op">&lt;-</span> <span class="va">projgrid</span><span class="op">$</span><span class="va">lattice</span><span class="op">$</span><span class="va">loc</span><span class="op">[</span><span class="va">xy.in</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">coord.prd</span>, type <span class="op">=</span> <span class="st">"p"</span>, cex <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_prd-1.png" width="700" style="display: block; margin: auto;"></p>
<p>Let us now create a <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> of the coordinates:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coord.prd.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="va">coord.prd</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                            x2 <span class="op">=</span> <span class="va">coord.prd</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="va">coord.prd.df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span></span></code></pre></div>
<p>Since we are using distance to the sea as a covariate, we also have
to calculate this covariate for the prediction locations. Finally, we
add the prediction location to our prediction <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code>,
namely, <code>coord.prd.df</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seaDist.prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spDistsN1.html" class="external-link">spDists</a></span><span class="op">(</span><span class="va">coord.prd</span>,</span>
<span>  <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="op">]</span>,</span>
<span>  longlat <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">min</span><span class="op">)</span></span>
<span><span class="va">coord.prd.df</span><span class="op">$</span><span class="va">seaDist</span> <span class="op">&lt;-</span> <span class="va">seaDist.prd</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rspde_fit</span>, <span class="va">coord.prd.df</span>, </span>
<span>        <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Intercept</span> <span class="op">+</span> <span class="va">field</span> <span class="op">+</span> <span class="va">distSea</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let us now build the data frame with the results:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_df</span> <span class="op">&lt;-</span> <span class="va">pred_obs</span><span class="op">@</span><span class="va">data</span></span>
<span><span class="va">pred_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pred_df</span>, <span class="va">pred_obs</span><span class="op">@</span><span class="va">coords</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we plot the results. First the predicted mean:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x1</span>, y <span class="op">=</span> <span class="va">x2</span>, fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/unnamed-chunk-5-1.png" width="700" style="display: block; margin: auto;"></p>
<p>Then, the std. deviations:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x1</span>, y <span class="op">=</span> <span class="va">x2</span>, fill <span class="op">=</span> <span class="va">sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_pred_sd_bru-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="an-example-with-replicates">An example with replicates<a class="anchor" aria-label="anchor" href="#an-example-with-replicates"></a>
</h2>
<p>For this example we will simulate a data with replicates. We will use
the same example considered in the <a href="rspde_cov.html">Rational
approximation with the <code>rSPDE</code> package</a> vignette (the only
difference is the way the data is organized). We also refer the reader
to this vignette for a description of the function
<code><a href="../reference/matern.operators.html">matern.operators()</a></code>, along with its methods (for instance,
the <code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> method).</p>
<div class="section level3">
<h3 id="simulating-the-data">Simulating the data<a class="anchor" aria-label="anchor" href="#simulating-the-data"></a>
</h3>
<p>Let us consider a simple Gaussian linear model with 30 independent
replicates of a latent spatial field <span class="math inline">\(x(\mathbf{s})\)</span>, observed at the same <span class="math inline">\(m\)</span> locations, <span class="math inline">\(\{\mathbf{s}_1 , \ldots , \mathbf{s}_m
\}\)</span>, for each replicate. For each <span class="math inline">\(i
= 1,\ldots,m,\)</span> we have</p>
<p><span class="math display">\[\begin{align}
y_i &amp;= x_1(\mathbf{s}_i)+\varepsilon_i,\\
\vdots &amp;= \vdots\\

y_{i+29m} &amp;= x_{30}(\mathbf{s}_i) + \varepsilon_{i+29m},
\end{align}\]</span></p>
<p>where <span class="math inline">\(\varepsilon_1,\ldots,\varepsilon_{30m}\)</span>
are iid normally distributed with mean 0 and standard deviation 0.1.</p>
<p>We use the basis function representation of <span class="math inline">\(x(\cdot)\)</span> to define the <span class="math inline">\(A\)</span> matrix linking the point locations to
the mesh. We also need to account for the fact that we have 30
replicates at the same locations. To this end, the <span class="math inline">\(A\)</span> matrix we need can be generated by
<code><a href="../reference/spde.make.A.html">spde.make.A()</a></code> function. The reason being that we are
sampling <span class="math inline">\(x(\cdot)\)</span> directly and not
the latent vector described in the introduction of the <a href="rspde_cov.html">Rational approximation with the <code>rSPDE</code>
package</a> vignette.</p>
<p>We begin by creating the mesh:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">loc_2d_mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, <span class="va">m</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">mesh_2d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d</a></span><span class="op">(</span></span>
<span>  loc <span class="op">=</span> <span class="va">loc_2d_mesh</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>  max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh_2d</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">loc_2d_mesh</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">loc_2d_mesh</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/unnamed-chunk-6-1.png" width="700" style="display: block; margin: auto;"></p>
<p>We then compute the <span class="math inline">\(A\)</span> matrix,
which is needed for simulation, and connects the observation locations
to the mesh. To this end we will use the <code><a href="../reference/spde.make.A.html">spde.make.A()</a></code>
helper function, which is a wrapper that uses the functions
<code><a href="https://inlabru-org.github.io/fmesher/reference/fm_basis.html" class="external-link">fm_basis()</a></code>, <code><a href="https://inlabru-org.github.io/fmesher/reference/fm_block.html" class="external-link">fm_block()</a></code> and
<code><a href="https://inlabru-org.github.io/fmesher/reference/fm_row_kron.html" class="external-link">fm_row_kron()</a></code> from the <code>fmesher</code> package.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n.rep</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spde.make.A.html">spde.make.A</a></span><span class="op">(</span></span>
<span>  mesh <span class="op">=</span> <span class="va">mesh_2d</span>,</span>
<span>  loc <span class="op">=</span> <span class="va">loc_2d_mesh</span>,</span>
<span>  index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">m</span>, times <span class="op">=</span> <span class="va">n.rep</span><span class="op">)</span>,</span>
<span>  repl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n.rep</span>, each <span class="op">=</span> <span class="va">m</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Notice that for the simulated data, we should use the <span class="math inline">\(A\)</span> matrix from <code><a href="../reference/spde.make.A.html">spde.make.A()</a></code>
function instead of the <code><a href="../reference/rspde.make.A.html">rspde.make.A()</a></code>.</p>
<p>We will now simulate a latent process with standard deviation <span class="math inline">\(\sigma=1\)</span> and range <span class="math inline">\(0.1\)</span>. We will use <span class="math inline">\(\nu=0.5\)</span> so that the model has an
exponential covariance function. To this end we create a model object
with the <code><a href="../reference/matern.operators.html">matern.operators()</a></code> function:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nu</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">range</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">kappa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">8</span> <span class="op">*</span> <span class="va">nu</span><span class="op">)</span> <span class="op">/</span> <span class="va">range</span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="va">nu</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">kappa</span><span class="op">^</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">nu</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="va">nu</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">operator_information</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matern.operators.html">matern.operators</a></span><span class="op">(</span></span>
<span>  mesh <span class="op">=</span> <span class="va">mesh_2d</span>,</span>
<span>  nu <span class="op">=</span> <span class="va">nu</span>,</span>
<span>  range <span class="op">=</span> <span class="va">range</span>,</span>
<span>  sigma <span class="op">=</span> <span class="va">sigma</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  parameterization <span class="op">=</span> <span class="st">"matern"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>More details on this function can be found at the <a href="rspde_cov.html">Rational approximation with the rSPDE package</a>
vignette.</p>
<p>To simulate the latent process all we need to do is to use the
<code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> method on the <code>operator_information</code>
object. We then obtain the simulated data <span class="math inline">\(y\)</span> by connecting with the <span class="math inline">\(A\)</span> matrix and adding the gaussian
noise.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">operator_information</span>, nsim <span class="op">=</span> <span class="va">n.rep</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">n.rep</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.1</span></span></code></pre></div>
<p>The first replicate of the simulated random field as well as the
observation locations are shown in the following figure.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_evaluate.html" class="external-link">fm_evaluator</a></span><span class="op">(</span><span class="va">mesh_2d</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_field</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">proj</span><span class="op">$</span><span class="va">lattice</span><span class="op">$</span><span class="va">loc</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                        y <span class="op">=</span> <span class="va">proj</span><span class="op">$</span><span class="va">lattice</span><span class="op">$</span><span class="va">loc</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>                        field <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_evaluate.html" class="external-link">fm_evaluate</a></span><span class="op">(</span><span class="va">proj</span>, </span>
<span>                        field <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        type <span class="op">=</span> <span class="st">"field"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">loc_2d_mesh</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>                      y <span class="op">=</span> <span class="va">loc_2d_mesh</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>                      field <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                      type <span class="op">=</span> <span class="st">"locations"</span><span class="op">)</span></span>
<span><span class="va">df_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">df_field</span>, <span class="va">df_loc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_plot</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">field</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">type</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_field</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_loc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">field</span><span class="op">)</span>,</span>
<span>        show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_colour_viridis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/unnamed-chunk-10-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="fitting-the-inlabru-rspde-model">Fitting the inlabru rSPDE model<a class="anchor" aria-label="anchor" href="#fitting-the-inlabru-rspde-model"></a>
</h3>
<p>Let us then use the rational SPDE approach to fit the data.</p>
<p>We begin by creating the model object.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rspde_model.rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">mesh_2d</span>,</span>
<span>          parameterization <span class="op">=</span> <span class="st">"spde"</span><span class="op">)</span> </span></code></pre></div>
<p>Let us now create the <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> and the vector with
the replicates indexes:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">loc_2d_mesh</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">n.rep</span><span class="op">)</span>,</span>
<span>                      x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">loc_2d_mesh</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">n.rep</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="va">rep.df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span></span>
<span><span class="va">repl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n.rep</span>, each<span class="op">=</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>Let us create the component and fit. It is extremely important not to
forget the <code>replicate</code> when fitting model with the
<code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru()</a></code> function. It will not produce warning and might fit
some meaningless model.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmp.rep</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu">field</span><span class="op">(</span><span class="va">coordinates</span>,</span>
<span>    model <span class="op">=</span> <span class="va">rspde_model.rep</span>,</span>
<span>    replicate <span class="op">=</span> <span class="va">repl</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">rspde_fit.rep</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span><span class="va">cmp.rep</span>,</span>
<span>    data <span class="op">=</span> <span class="va">rep.df</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"gaussian"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can get the summary:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rspde_fit.rep</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## inlabru version: 2.9.0</span></span>
<span><span class="co">## INLA version: 23.10.25</span></span>
<span><span class="co">## Components:</span></span>
<span><span class="co">## field: main = cgeneric(coordinates), group = exchangeable(1L), replicate = iid(repl)</span></span>
<span><span class="co">## Likelihoods:</span></span>
<span><span class="co">##   Family: 'gaussian'</span></span>
<span><span class="co">##     Data class: 'SpatialPointsDataFrame'</span></span>
<span><span class="co">##     Predictor: y ~ .</span></span>
<span><span class="co">## Time used:</span></span>
<span><span class="co">##     Pre = 0.534, Running = 1058, Post = 19.7, Total = 1078 </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##   Name     Model</span></span>
<span><span class="co">##     field CGeneric</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model hyperparameters:</span></span>
<span><span class="co">##                                           mean    sd 0.025quant 0.5quant</span></span>
<span><span class="co">## Precision for the Gaussian observations 101.05 7.275      87.46   100.79</span></span>
<span><span class="co">## Theta1 for field                         -2.98 0.077      -3.16    -2.98</span></span>
<span><span class="co">## Theta2 for field                          3.08 0.036       3.01     3.08</span></span>
<span><span class="co">## Theta3 for field                         -1.66 0.036      -1.72    -1.66</span></span>
<span><span class="co">##                                         0.975quant   mode</span></span>
<span><span class="co">## Precision for the Gaussian observations     116.09 100.30</span></span>
<span><span class="co">## Theta1 for field                             -2.86  -2.93</span></span>
<span><span class="co">## Theta2 for field                              3.15   3.08</span></span>
<span><span class="co">## Theta3 for field                             -1.57  -1.68</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Deviance Information Criterion (DIC) ...............: -5793.16</span></span>
<span><span class="co">## Deviance Information Criterion (DIC, saturated) ....: 10856.25</span></span>
<span><span class="co">## Effective number of parameters .....................: 4853.80</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Watanabe-Akaike information criterion (WAIC) ...: -6859.16</span></span>
<span><span class="co">## Effective number of parameters .................: 2773.09</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Marginal log-Likelihood:  -4539.60 </span></span>
<span><span class="co">##  is computed </span></span>
<span><span class="co">## Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre>
<p>and the summary in the user’s scale:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_fit_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit.rep</span>, <span class="st">"field"</span>, <span class="va">rspde_model.rep</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_fit_rep</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             mean         sd 0.025quant   0.5quant 0.975quant       mode</span></span>
<span><span class="co">## tau    0.0507729 0.00382052  0.0425098  0.0511662  0.0571211  0.0530676</span></span>
<span><span class="co">## kappa 21.7653000 0.77643700 20.3017000 21.7423000 23.3502000 21.6869000</span></span>
<span><span class="co">## nu     0.6414820 0.01960410  0.6101190  0.6389200  0.6857020  0.6300200</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tau"</span>, <span class="st">"kappa"</span>, <span class="st">"nu"</span><span class="op">)</span>,</span>
<span>  true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tau</span>, <span class="va">kappa</span>, <span class="va">nu</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.tau</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.kappa</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.nu</span><span class="op">$</span><span class="va">mean</span></span>
<span>  <span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.tau</span><span class="op">$</span><span class="va">mode</span>,</span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.kappa</span><span class="op">$</span><span class="va">mode</span>,</span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.nu</span><span class="op">$</span><span class="va">mode</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   parameter        true        mean       mode</span></span>
<span><span class="co">## 1       tau  0.08920621  0.05077288  0.0530676</span></span>
<span><span class="co">## 2     kappa 20.00000000 21.76525677 21.6868788</span></span>
<span><span class="co">## 3        nu  0.50000000  0.64148235  0.6300204</span></span></code></pre>
<p>Let us also obtain the summary on the <code>matern</code>
parameterization:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_fit_rep_matern</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit.rep</span>, <span class="st">"field"</span>, <span class="va">rspde_model.rep</span>, </span>
<span>                          parameterization <span class="op">=</span> <span class="st">"matern"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_fit_rep_matern</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             mean         sd 0.025quant 0.5quant 0.975quant     mode</span></span>
<span><span class="co">## std.dev 1.072210 0.01283110  1.0478800 1.072130   1.098000 1.074260</span></span>
<span><span class="co">## range   0.103751 0.00429796  0.0956853 0.103618   0.112577 0.102472</span></span>
<span><span class="co">## nu      0.641482 0.01960410  0.6101190 0.638920   0.685702 0.630020</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_df_matern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"std_dev"</span>, <span class="st">"range"</span>, <span class="st">"nu"</span><span class="op">)</span>,</span>
<span>  true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="va">range</span>, <span class="va">nu</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">result_fit_rep_matern</span><span class="op">$</span><span class="va">summary.std.dev</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>    <span class="va">result_fit_rep_matern</span><span class="op">$</span><span class="va">summary.range</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>    <span class="va">result_fit_rep_matern</span><span class="op">$</span><span class="va">summary.nu</span><span class="op">$</span><span class="va">mean</span></span>
<span>  <span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.std.dev</span><span class="op">$</span><span class="va">mode</span>,</span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.range</span><span class="op">$</span><span class="va">mode</span>,</span>
<span>    <span class="va">result_fit_rep</span><span class="op">$</span><span class="va">summary.nu</span><span class="op">$</span><span class="va">mode</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_df_matern</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   parameter true      mean      mode</span></span>
<span><span class="co">## 1   std_dev  1.0 1.0722133 0.6300204</span></span>
<span><span class="co">## 2     range  0.1 0.1037509 0.6300204</span></span>
<span><span class="co">## 3        nu  0.5 0.6414823 0.6300204</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="an-example-with-a-non-stationary-model">An example with a non-stationary model<a class="anchor" aria-label="anchor" href="#an-example-with-a-non-stationary-model"></a>
</h2>
<p>Our goal now is to show how one can fit model with non-stationary
<span class="math inline">\(\sigma\)</span> (std. deviation) and
non-stationary <span class="math inline">\(\rho\)</span> (a range
parameter). One can also use the parameterization in terms of
non-stationary SPDE parameters <span class="math inline">\(\kappa\)</span> and <span class="math inline">\(\tau\)</span>.</p>
<p>For this example we will consider simulated data.</p>
<div class="section level3">
<h3 id="simulating-the-data-1">Simulating the data<a class="anchor" aria-label="anchor" href="#simulating-the-data-1"></a>
</h3>
<p>Let us consider a simple Gaussian linear model with a latent spatial
field <span class="math inline">\(x(\mathbf{s})\)</span>, defined on the
rectangle <span class="math inline">\((0,10) \times (0,5)\)</span>,
where the std. deviation and range parameter satisfy the following
log-linear regressions: <span class="math display">\[\begin{align}
\log(\sigma(\mathbf{s})) &amp;= \theta_1 + \theta_3 b(\mathbf{s}),\\
\log(\rho(\mathbf{s})) &amp;= \theta_2 + \theta_3 b(\mathbf{s}),
\end{align}\]</span> where <span class="math inline">\(b(\mathbf{s}) =
(s_1-5)/10\)</span>. We assume the data is observed at <span class="math inline">\(m\)</span> locations, <span class="math inline">\(\{\mathbf{s}_1 , \ldots , \mathbf{s}_m
\}\)</span>. For each <span class="math inline">\(i =
1,\ldots,m,\)</span> we have</p>
<p><span class="math display">\[y_i =
x_1(\mathbf{s}_i)+\varepsilon_i,\]</span></p>
<p>where <span class="math inline">\(\varepsilon_1,\ldots,\varepsilon_{m}\)</span> are
iid normally distributed with mean 0 and standard deviation 0.1.</p>
<p>We begin by defining the domain and creating the mesh:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_domain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d</a></span><span class="op">(</span>loc.domain <span class="op">=</span> <span class="va">rec_domain</span>, cutoff <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>  max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span>, offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We follow the same structure as <code>INLA</code>. However,
<code>INLA</code> only allows one to specify <code>B.tau</code> and
<code>B.kappa</code> matrices, and, in <code>INLA</code>, if one wants
to parameterize in terms of range and standard deviation one needs to do
it manually. Here we provide the option to directly provide the matrices
<code>B.sigma</code> and <code>B.range</code>.</p>
<p>The usage of the matrices <code>B.tau</code> and <code>B.kappa</code>
are identical to the corresponding ones in
<code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.matern.html" class="external-link">inla.spde2.matern()</a></code> function. The matrices
<code>B.sigma</code> and <code>B.range</code> work in the same way, but
they parameterize the stardard deviation and range, respectively.</p>
<p>The columns of the <code>B</code> matrices correspond to the same
parameter. The first column does not have any parameter to be estimated,
it is a constant column.</p>
<p>So, for instance, if one wants to share a parameter with both
<code>sigma</code> and <code>range</code> (or with both <code>tau</code>
and <code>kappa</code>), one simply let the corresponding column to be
nonzero on both <code>B.sigma</code> and <code>B.range</code> (or on
<code>B.tau</code> and <code>B.kappa</code>).</p>
<p>We will assume <span class="math inline">\(\nu = 0.8\)</span>, <span class="math inline">\(\theta_1 = 0, \theta_2 = 1\)</span> and <span class="math inline">\(\theta_3=1\)</span>. Let us now build the model to
obtain the sample with the <code><a href="../reference/spde.matern.operators.html">spde.matern.operators()</a></code>
function:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nu</span> <span class="op">&lt;-</span> <span class="fl">0.8</span></span>
<span><span class="va">true_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">B.sigma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">(</span><span class="va">mesh</span><span class="op">$</span><span class="va">loc</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">B.range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="op">(</span><span class="va">mesh</span><span class="op">$</span><span class="va">loc</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SPDE model</span></span>
<span><span class="va">op_cov_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spde.matern.operators.html">spde.matern.operators</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">mesh</span>, </span>
<span>  theta <span class="op">=</span> <span class="va">true_theta</span>,</span>
<span>  nu <span class="op">=</span> <span class="va">nu</span>,</span>
<span>  B.sigma <span class="op">=</span> <span class="va">B.sigma</span>, </span>
<span>  B.range <span class="op">=</span> <span class="va">B.range</span>, m <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  parameterization <span class="op">=</span> <span class="st">"matern"</span><span class="op">)</span></span></code></pre></div>
<p>Let us now sample the data with the <code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code>
method:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">op_cov_ns</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let us now obtain 600 random locations on the rectangle and compute
the <span class="math inline">\(A\)</span> matrix:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">600</span></span>
<span><span class="va">loc_mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spde.make.A.html">spde.make.A</a></span><span class="op">(</span></span>
<span>  mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  loc <span class="op">=</span> <span class="va">loc_mesh</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can now generate the response vector <code>y</code>:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">A</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-the-inlabru-rspde-model-1">Fitting the inlabru rSPDE model<a class="anchor" aria-label="anchor" href="#fitting-the-inlabru-rspde-model-1"></a>
</h3>
<p>Let us then use the rational SPDE approach to fit the data.</p>
<p>We begin by creating the model object. We are creating a new one so
that we do not start the estimation at the true values.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rspde_model_nonstat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.matern.html">rspde.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  B.sigma <span class="op">=</span> <span class="va">B.sigma</span>,</span>
<span>  B.range <span class="op">=</span> <span class="va">B.range</span>,</span>
<span>  parameterization <span class="op">=</span> <span class="st">"matern"</span><span class="op">)</span> </span></code></pre></div>
<p>Let us now create the <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> and the vector with
the replicates indexes:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nonstat_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x1 <span class="op">=</span> <span class="va">loc_mesh</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                      x2 <span class="op">=</span> <span class="va">loc_mesh</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="va">nonstat_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span></span></code></pre></div>
<p>Let us create the component and fit. It is extremely important not to
forget the <code>replicate</code> when fitting model with the
<code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru()</a></code> function. It will not produce warning and might fit
some meaningless model.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmp_nonstat</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu">field</span><span class="op">(</span><span class="va">coordinates</span>,</span>
<span>    model <span class="op">=</span> <span class="va">rspde_model_nonstat</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">rspde_fit_nonstat</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span><span class="va">cmp_nonstat</span>,</span>
<span>    data <span class="op">=</span> <span class="va">nonstat_df</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can get the summary:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rspde_fit_nonstat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## inlabru version: 2.9.0</span></span>
<span><span class="co">## INLA version: 23.10.25</span></span>
<span><span class="co">## Components:</span></span>
<span><span class="co">## field: main = cgeneric(coordinates), group = exchangeable(1L), replicate = iid(1L)</span></span>
<span><span class="co">## Likelihoods:</span></span>
<span><span class="co">##   Family: 'gaussian'</span></span>
<span><span class="co">##     Data class: 'SpatialPointsDataFrame'</span></span>
<span><span class="co">##     Predictor: y ~ .</span></span>
<span><span class="co">## Time used:</span></span>
<span><span class="co">##     Pre = 0.496, Running = 636, Post = 0.819, Total = 637 </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##   Name     Model</span></span>
<span><span class="co">##     field CGeneric</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model hyperparameters:</span></span>
<span><span class="co">##                                            mean     sd 0.025quant 0.5quant</span></span>
<span><span class="co">## Precision for the Gaussian observations 105.113 11.283     84.780  104.470</span></span>
<span><span class="co">## Theta1 for field                         -0.128  0.119     -0.366   -0.127</span></span>
<span><span class="co">## Theta2 for field                          0.773  0.171      0.435    0.774</span></span>
<span><span class="co">## Theta3 for field                          0.969  0.462     -0.024    0.997</span></span>
<span><span class="co">## Theta4 for field                         -1.217  0.198     -1.619   -1.212</span></span>
<span><span class="co">##                                         0.975quant    mode</span></span>
<span><span class="co">## Precision for the Gaussian observations    129.153 103.111</span></span>
<span><span class="co">## Theta1 for field                             0.103  -0.122</span></span>
<span><span class="co">## Theta2 for field                             1.106   0.778</span></span>
<span><span class="co">## Theta3 for field                             1.783   1.136</span></span>
<span><span class="co">## Theta4 for field                            -0.840  -1.194</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Deviance Information Criterion (DIC) ...............: -730.00</span></span>
<span><span class="co">## Deviance Information Criterion (DIC, saturated) ....: 947.80</span></span>
<span><span class="co">## Effective number of parameters .....................: 348.45</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Watanabe-Akaike information criterion (WAIC) ...: -767.60</span></span>
<span><span class="co">## Effective number of parameters .................: 235.01</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Marginal log-Likelihood:  -13.72 </span></span>
<span><span class="co">##  is computed </span></span>
<span><span class="co">## Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre>
<p>We can obtain outputs with respect to parameters in the original
scale by using the function <code><a href="../reference/rspde.result.html">rspde.result()</a></code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_fit_nonstat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspde.result.html">rspde.result</a></span><span class="op">(</span><span class="va">rspde_fit_nonstat</span>, <span class="st">"field"</span>, <span class="va">rspde_model_nonstat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_fit_nonstat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                    mean       sd 0.025quant  0.5quant 0.975quant      mode</span></span>
<span><span class="co">## Theta1.matern -0.128236 0.119093 -0.3659800 -0.127123    0.10294 -0.122394</span></span>
<span><span class="co">## Theta2.matern  0.772973 0.170513  0.4345620  0.773898    1.10596  0.777796</span></span>
<span><span class="co">## Theta3.matern  0.969207 0.462312 -0.0243082  0.997304    1.78273  1.135690</span></span>
<span><span class="co">## nu             0.921603 0.137980  0.6638590  0.918039    1.20358  0.914894</span></span></code></pre>
<p>Let us compare the mean to the true values of the parameters:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summ_res_nonstat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result_fit_nonstat</span><span class="op">)</span></span>
<span><span class="va">result_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="va">result_fit_nonstat</span><span class="op">$</span><span class="va">params</span>,</span>
<span>  true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">true_theta</span>, <span class="va">nu</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span> <span class="va">summ_res_nonstat</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  mode <span class="op">=</span> <span class="va">summ_res_nonstat</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       parameter true      mean      mode</span></span>
<span><span class="co">## 1 Theta1.matern  0.0 -0.128236 -0.122394</span></span>
<span><span class="co">## 2 Theta2.matern  1.0  0.772973  0.777796</span></span>
<span><span class="co">## 3 Theta3.matern  1.0  0.969207  1.135690</span></span>
<span><span class="co">## 4            nu  0.8  0.921603  0.914894</span></span></code></pre>
<p>We can also plot the posterior densities. To this end we will use the
<code><a href="../reference/gg_df.html">gg_df()</a></code> function, which creates <code>ggplot2</code>
user-friendly data frames:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior_df_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gg_df.html">gg_df</a></span><span class="op">(</span><span class="va">result_fit_nonstat</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">posterior_df_fit</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rspde_inlabru_files/figure-html/plot_post_nonstat-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="further-options-of-the-inlabru-implementation">Further options of the <code>inlabru</code> implementation<a class="anchor" aria-label="anchor" href="#further-options-of-the-inlabru-implementation"></a>
</h2>
<p>There are several additional options that are available. For
instance, it is possible to change the order of the rational
approximation, the upper bound for the smoothness parameter (which may
speed up the fit), change the priors, change the type of the rational
approximation, among others. These options are described in the “Further
options of the <code>rSPDE</code>-<code>INLA</code> implementation”
section of the <a href="rspde_inla.html">R-INLA implementation of the
rational SPDE approach</a> vignette. Observe that all these options are
passed to the model through the <code><a href="../reference/rspde.matern.html">rspde.matern()</a></code> function,
and therefore the resulting model object can directly be used in the
<code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru()</a></code> function, in an identical manner to the examples
above.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-xiong22" class="csl-entry">
Bolin, David, Alexandre B. Simas, and Zhen Xiong. 2023.
<span>“Covariance-Based Rational Approximations of Fractional SPDEs for
Computationally Efficient Bayesian Inference.”</span> <em>Journal of
Computational and Graphical Statistics</em>.
</div>
<div id="ref-lindgren11" class="csl-entry">
Lindgren, Finn, Håvard Rue, and Johan Lindström. 2011. <span>“An
Explicit Link Between Gaussian Fields and Gaussian Markov Random Fields:
The Stochastic Partial Differential Equation Approach.”</span>
<em>Journal of the Royal Statistical Society. Series B. Statistical
Methodology</em> 73 (4): 423–98.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Bolin, Alexandre Simas.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
